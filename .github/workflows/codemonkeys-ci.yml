# Code Monkeys CI Workflow
#
# Branching Model:
#   main  = stable/release (PRs only)
#   dev   = integration (feature branches merge here)
#   feature/* = work branches
#
# Runs on:
#   - Push to dev
#   - PRs to dev or main

name: Code Monkeys CI

on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev, main]

env:
  PYTHON_VERSION: "3.10"

jobs:
  validate:
    name: Validate & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest jsonschema

      - name: Run pytest (schema tests)
        run: |
          pytest tests/dash/ -v --tb=short 2>&1 | tee pytest_output.log

      - name: Run Silverback validation
        run: |
          python scripts/silverback_validate.py --all 2>&1 | tee silverback_output.log

      - name: Generate run report (CI mode)
        run: |
          python scripts/generate_run_report.py codemonkeys-dash --ci --test-path tests/dash/

      - name: Verify artifact exists (Evidence is mandatory)
        run: |
          if [ ! -f "dash/runs/codemonkeys-dash/last_run.json" ]; then
            echo "FATAL: last_run.json was not generated. Evidence is mandatory."
            exit 1
          fi
          echo "last_run.json exists"
          cat dash/runs/codemonkeys-dash/last_run.json

      - name: Upload CI artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ci-artifacts
          path: |
            pytest_output.log
            silverback_output.log
            dash/runs/codemonkeys-dash/last_run.json
          retention-days: 30
        if: always()
